name: Selenium TestNG CI (Cross-Browser XML Driven)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
    contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. Set up system environment for better stability
      - name: Setup system environment
        run: |
          # Increase virtual memory
          sudo sysctl -w vm.max_map_count=262144
          # Clean up any existing selenium temp files
          sudo rm -rf /tmp/selenium-* || true
          # Create dedicated temp directory
          mkdir -p /tmp/selenium-tests
          export TMPDIR=/tmp/selenium-tests

      # 4. Install Chrome
      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # 5. Install Firefox via APT (not Snap)
      - name: Install Firefox (APT)
        run: |
          sudo snap remove firefox || true
          sudo add-apt-repository ppa:mozillateam/ppa -y
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
          sudo apt-get update
          sudo apt-get install -y firefox

      # 6. Install Microsoft Edge
      - name: Install Microsoft Edge
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main" | sudo tee /etc/apt/sources.list.d/microsoft-edge.list
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable

      # 7. Verify browser versions
      - name: Verify browser versions
        run: |
          google-chrome --version
          firefox --version
          microsoft-edge --version

      # 8. Set up display for headless mode
      - name: Setup virtual display
        run: |
          sudo apt-get install -y xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &

      # 9. Run TestNG suite (Cross-Browser) with timeout and retries
      - name: Run TestNG suite
        run: |
          export DISPLAY=:99
          timeout 30m mvn clean test -DsuiteXmlFile=testng.xml -Dmaven.test.failure.ignore=true
        continue-on-error: true

      # 10. Cleanup selenium temp files
      - name: Cleanup temp files
        if: always()
        run: |
          sudo rm -rf /tmp/selenium-* || true
          sudo rm -rf /tmp/selenium-tests || true

      # 11. Generate Allure Report
      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: target/allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history

      # 12. Deploy to GitHub Pages
      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: allure-report

      # 13. Upload artifacts as backup
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results
          if-no-files-found: warn

      # 14. Comment PR with report link
      - name: Comment PR with Allure Report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ“Š **Allure Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/'
            })
            

        # 15. Extract test results summary
      - name: Extract Test Results
        if: always()
        id: test-results
        run: |
                # Create a summary of test results
                if [ -f "target/allure-results/allure-report.json" ] || [ -d "target/allure-results" ]; then
                  # Count test files to get approximate results
                  TOTAL_TESTS=$(find target/allure-results -name "*.json" -type f | grep -E "(test-result|test-case)" | wc -l)

                  # Try to extract from surefire reports if available
                  if [ -d "target/surefire-reports" ]; then
                    FAILED_TESTS=$(find target/surefire-reports -name "*.xml" -exec grep -l 'failures="[^0]"' {} \; | wc -l)
                    PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
                  else
                    FAILED_TESTS="Unknown"
                    PASSED_TESTS="Unknown"
                  fi

                  echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
                  echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
                  echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
                else
                  echo "total_tests=0" >> $GITHUB_OUTPUT
                  echo "passed_tests=0" >> $GITHUB_OUTPUT
                  echo "failed_tests=0" >> $GITHUB_OUTPUT
                fi

            # 16. Send email notification with results
            - name: Send Email Notification
              if: always()
              uses: dawidd6/action-send-mail@v3
              with:
                server_address: smtp.gmail.com
                server_port: 587
                username: ${{ secrets.EMAIL_USERNAME }}
                password: ${{ secrets.EMAIL_PASSWORD }}
                subject: "ğŸ§ª Test Results: ${{ github.repository }} - ${{ github.ref_name }}"
                to: ${{ secrets.EMAIL_RECIPIENT }}
                from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
                html_body: |
                  <html>
                  <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px 10px 0 0;">
                      <h1 style="color: white; margin: 0;">ğŸ§ª Test Execution Report</h1>
                      <p style="color: #f0f0f0; margin: 5px 0 0 0;">Repository: ${{ github.repository }}</p>
                    </div>

                    <div style="background: white; padding: 20px; border: 1px solid #e1e5e9; border-radius: 0 0 10px 10px;">
                      <h2 style="color: #333;">ğŸ“Š Test Results Summary</h2>

                      <div style="display: flex; gap: 15px; margin: 20px 0;">
                        <div style="flex: 1; background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                          <h3 style="margin: 0; color: #1976d2;">Total Tests</h3>
                          <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #1976d2;">${{ steps.test-results.outputs.total_tests }}</p>
                        </div>
                        <div style="flex: 1; background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                          <h3 style="margin: 0; color: #388e3c;">Passed</h3>
                          <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #388e3c;">${{ steps.test-results.outputs.passed_tests }}</p>
                        </div>
                        <div style="flex: 1; background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                          <h3 style="margin: 0; color: #d32f2f;">Failed</h3>
                          <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #d32f2f;">${{ steps.test-results.outputs.failed_tests }}</p>
                        </div>
                      </div>

                      <h3 style="color: #333;">ğŸ“‹ Execution Details</h3>
                      <ul style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                        <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
                        <li><strong>Commit:</strong> ${{ github.sha }}</li>
                        <li><strong>Triggered by:</strong> ${{ github.event_name }}</li>
                        <li><strong>Workflow:</strong> ${{ github.workflow }}</li>
                        <li><strong>Run ID:</strong> ${{ github.run_id }}</li>
                      </ul>

                      <h3 style="color: #333;">ğŸ”— Quick Links</h3>
                      <div style="margin: 15px 0;">
                        <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report/" 
                           style="display: inline-block; background: #4caf50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-right: 10px;">
                          ğŸ“Š View Allure Report
                        </a>
                        <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                           style="display: inline-block; background: #2196f3; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                          ğŸ” View Workflow
                        </a>
                      </div>

                      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e5e9; font-size: 12px; color: #666;">
                        <p>This email was automatically generated by GitHub Actions.</p>
                        <p>Generated on: $(date)</p>
                      </div>
                    </div>
                  </body>
                  </html>
                attachments: |
                  target/allure-results/**/*